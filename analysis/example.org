#+TITLE: Linear regression with spike and slab prior
#+AUTHOR: Abhishek Sarkar
#+OPTIONS: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline author:t c:nil
#+OPTIONS: creator:comment d:(not "LOGBOOK") date:t e:t email:nil f:t inline:t
#+OPTIONS: num:t p:nil pri:nil stat:t tags:t tasks:t tex:t timestamp:t toc:t
#+OPTIONS: todo:t |:t
#+CREATOR: Emacs 25.1.1 (Org mode 8.2.10)
#+DESCRIPTION:
#+EXCLUDE_TAGS: noexport
#+KEYWORDS:
#+LANGUAGE: en
#+SELECT_TAGS: export

#+BEGIN_SRC python :tangle example.py
  import edward as ed
  import matplotlib.pyplot as plt
  import numpy
  import nwas
  import scipy.special
  import tensorflow as tf

  from edward.models import *
  from nwas.models import *
#+END_SRC

Simulate some data:

#+BEGIN_SRC python :tangle example.py
  p = 10000
  n_gwas = 7500
  n_validate = 1000
  pve_y = 0.5

  with nwas.simulation.simulation(p, pve_y, [(100, 1)], 0) as s:
      true_w = s.theta.reshape(-1, 1)
      x_gwas, y_gwas = s.sample_gaussian(n=n_gwas)
      x_validate, y_validate = s.sample_gaussian(n=n_validate)
      x_gwas = x_gwas.astype('float32')
      y_gwas = y_gwas.reshape(-1, 1).astype('float32')
      x_validate = x_validate.astype('float32')
      y_validate = y_validate.reshape(-1, 1).astype('float32')
#+END_SRC

Set up the model:

#+BEGIN_SRC python :tangle example.py
  logodds = Normal(loc=-numpy.log(p).astype('float32'), scale=tf.ones(1))
  scale = Normal(loc=tf.zeros([1]), scale=tf.ones([1]))
  w = SpikeSlab(logodds=logodds,
                loc=tf.zeros([p, 1]),
                scale=scale,
  )
  eta = GeneticValue(x=x_gwas, theta=w)
  p_y = NormalWithSoftplusScale(loc=eta, scale=tf.Variable(tf.zeros([1])))
#+END_SRC

Set up the variational approximation:

#+BEGIN_SRC python :tangle example.py
  q_logodds = Normal(loc=tf.Variable(tf.random_normal([1])),
                     scale=tf.Variable(tf.random_normal([1])))
  q_scale = Normal(loc=tf.Variable(tf.random_normal([1])),
                   scale=tf.Variable(tf.random_normal([1])))
  q_w = SpikeSlab(
      logodds=tf.Variable(tf.zeros([p, 1])),
      loc=tf.Variable(tf.zeros([p, 1])),
      scale=tf.Variable(tf.zeros([p, 1])))
  q_eta = GeneticValue(x=x_gwas, theta=q_w)
#+END_SRC

Fit the approximation:

#+BEGIN_SRC python :tangle example.py
  inference = ed.ReparameterizationKLKLqp(
      latent_vars={
          logodds: q_logodds,
          scale: q_scale,
          w: q_w,
          eta: q_eta,
      },
      data={
          p_y: y_gwas,
      })

  inference.run(n_iter=1000, optimizer='rmsprop')
#+END_SRC

Plot the fit:

#+BEGIN_SRC python :tangle example.py :exports both :file example.pdf
  session = ed.get_session()
  pip = session.run(q_w.pip)
  est_w = session.run(q_w.mean())

  plt.switch_backend('pdf')
  q = numpy.logical_or(pip > 0.1, true_w != 0)
  nq = numpy.count_nonzero(q)
  fig, ax = plt.subplots(3, 1)
  fig.set_size_inches(6, 8)
  plt.xlabel('True and false positive variants')
  ax[0].bar(range(nq), true_w[q])
  ax[0].set_ylabel('True effect size')
  ax[1].bar(range(nq), est_w[q])
  ax[1].set_ylabel('Estimated effect size')
  ax[2].bar(range(nq), pip[q])
  ax[2].set_ylabel('PIP')
  plt.savefig('example')
  plt.close()
#+END_SRC
